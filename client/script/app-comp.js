const treePath="tree",arSigns=["ِ","ُ","ٓ","ٰ","ْ","ٌ","ٍ","ً","ّ","َ"],extras=["\\?","!","#","&","\\*","\\(","\\)","-","\\+","=","_","\\[","\\]","{","}","<",">","/","|","'",'"',";",":",",","\\.","~","`","؟","،","»","«","ـ","؛","›","‹","•","‌","‎","‏"],_assoc={en:["0","1","2","3","4","5","6","7","8","9"],fa:["۰","۱","۲","۳","۴","۵","۶","۷","۸","۹"],ckb:["٠","١","٢","٣","٤","٥","٦","٧","٨","٩"]},from=["ك","ي","ى","ھ"],to=["ک","ی","ی","ه"],langStorage="lang",defaultLang="fa",availableLangs={fa:{cc:"fa",dir:"rtl",lang:"fa-IR",align:"right",anti:"left"}};let currentLang,currentLangCc;const Ps={title:{fa:"کتاب‌خانه"},header:{fa:"کتابــــــ‌خانه"},desc:{fa:"کتاب‌خانه دانشگاه آزاد سردشت"},"search in books":{fa:"جست‌وجو در کتاب‌ها..."},search:{fa:"جست‌وجو"},"< back":{fa:"بازگشت ›"},plan:{fa:"برنامه کاری کتاب‌خانه"},"not found":{fa:"نتیجه‌ای یافت نشد."}},html=document.querySelector("html"),head=document.head,body=document.body,defTargetId="#result",defTarget=body.querySelector("#result"),versionStorage="version",versionPath="VERSION",lockStorage="lock",lockTimeout=6e4,themeStorage="theme",availableThemes={light:{name:"light",colors:["#FFF","#000","#900","#ddd"],icon:"brightness_5"},dark:{name:"dark",colors:["#444","#FFF","#6FF","#666"],icon:"brightness_2"}};let currentTheme;function getLang(){let e=localStorage.getItem(langStorage);return e in availableLangs||(e=defaultLang),availableLangs[e]}function setLang(e){localStorage.setItem(langStorage,e)}function applyLang(e){html.setAttribute("lang",e.lang),html.setAttribute("dir",e.dir),head.querySelector("title").innerText=P("title"),body.querySelector("header h1").innerText=P("header"),body.querySelector("header h2").innerText=P("desc"),body.querySelector("#qTxt").setAttribute("placeholder",P("search in books")),body.querySelector("#close").innerText=P("< back"),body.querySelector("#planBtn").innerText=P("plan")}function P(e){try{return Ps[e][currentLangCc]}catch(e){return""}}function find(e,t,n=-1,o=null){const r=body.querySelector(t);(e=sanitizeStr(e))?(o||(o=e[0]),loadItem(`${treePath}/${o}/list`,function(t){let l=t?_filter(e,o,t,r,n):null;if(l)r.innerHTML=l,applyTheme(currentTheme);else{r.innerHTML="";const t=downloadedListsFirstChars();n=Math.ceil(n/t.length)+1;for(const o of t)loadItem(`${treePath}/${o}/list`,function(t){l=_filter(e,o,t,r,n),r.innerHTML+=l,applyTheme(currentTheme)})}})):r.innerHTML=""}function _filter(e,t,n,o,r){let l="";n=n.split("\n");for(let o of n){if(0==r)break;if((o=o.split("\t")).length<3)continue;const n=o[1];if(-1!==o[2].indexOf(e)){const e=o[0];l+=`<button type='button' onclick='O("${`${treePath}/${t}/${e}`}")'>\n<i class='icon'>book</i> ${n}</button>`,r--}}return l}function O(e){const t=body.querySelector("#D"),n=t.querySelector("#res");t.style.display="block",loadItem(e,function(e){n.innerHTML=`${e.replace(/\n/g,"<br>")}`})}function loadItem(e,t){const n=localStorage.getItem(e);null===n?downloadItem(e,t):(t(n),updateItem(e))}function downloadItem(e,t){lockedGetUrl(e,function(n){if(null===n)return void t(null);let o=404===n.status?"":n.responseText;o&&e.endsWith("/list")&&(o=sanList(o)),localStorage.setItem(e,o),t(o),404!==n.status&&lockedGetUrl(versionPath,function(n){null!==n?localStorage.setItem(`${e}_ver`,n.responseText):t(null)},`${e}_ver`)})}function lockedGetUrl(e,t,n=null){n||(n=e),isLOCK(n)?t(null):(LOCK(n),getUrl(e,function(e){unLOCK(n),t(e)}))}function updateItem(e){parseInt(localStorage.getItem(versionStorage))>parseInt(localStorage.getItem(`${e}_ver`))&&downloadItem(e,e=>null)}function sanitizeStr(e){for(const t of extras)e=e.replace(new RegExp(t,"g"),"");for(const t of arSigns)e=e.replace(new RegExp(t,"g"),"");for(const t in from)e=e.replace(new RegExp(from[t],"g"),to[t]);return e=numConvert(e=e.toLowerCase(),"fa","en"),e=(e=numConvert(e,"ckb","en")).replace(/\s+/g,"")}function numConvert(e,t,n){for(const o in _assoc.en)e=e.replace(new RegExp(_assoc[t][o],"g"),_assoc[n][o]);return e}function chars(e){return e.split()}function makePath(e){return chars(e).join("/")}function getUrl(e,t){const n=new XMLHttpRequest;n.open("get",NEW(e)),n.onload=function(){t(this)},n.send()}function plan(){const e=body.querySelector("#D"),t=e.querySelector("#res");e.style.display="block",getUrl("plan",function(e){let n="<table>";const o=e.responseText.split("\n");for(const e of o){if(!e.trim())continue;const t=e.split("  ");n+=`<tr><td>${t[0]}</td><td>${t[1]}</td></tr>`}n+="</table>",t.innerHTML=n})}function setTheme(e){localStorage.setItem(themeStorage,e)}function getTheme(){let e=localStorage.getItem(themeStorage);return e in availableThemes||(e=timeTheme()),availableThemes[e]}function timeTheme(){const e=(new Date).getHours();return e>6&&e<18?"light":"dark"}function applyTheme(e){setThemeIcon();const t=e.colors[0],n=e.colors[1],o=e.colors[2],r=e.colors[3],l=body.querySelector("#close"),a=body.querySelector("#qTxt");body.style.background=t,body.style.color=n,body.querySelector("header h1").style.color=o,body.querySelector("#D").style.background=t,a.style.borderBottomColor=r,a.addEventListener("focus",function(){a.style.borderBottomColor=n}),a.addEventListener("blur",function(){a.style.borderBottomColor=r}),l.style.background=r,l.style.color=n,l.addEventListener("mouseenter",function(){l.style.background=n,l.style.color=t}),l.addEventListener("mouseleave",function(){l.style.background=r,l.style.color=n}),body.querySelectorAll("button").forEach(function(e){e.style.color=n,e.addEventListener("mouseenter",function(){e.style.color=o}),e.addEventListener("mouseleave",function(){e.style.color=n})})}function setThemeIcon(){const e=body.querySelector("#themeBtn");localStorage.getItem(themeStorage)?"light"==currentTheme.name?e.innerText=availableThemes.light.icon:e.innerText=availableThemes.dark.icon:e.innerText=availableThemes.light.icon+availableThemes.dark.icon}function downloadedListsFirstChars(){let e=[];for(let t=0;t<localStorage.length;t++){const n=localStorage.key(t);n.endsWith("/list")&&e.push(n.substr(-6,1))}return e}function sanList(e){e=e.split("\n");for(const t in e){let n=e[t];(n=n.split("\t"))[2]=sanitizeStr(n[1]),n=n.join("\t"),e[t]=n}return e=e.join("\n")}function NEW(e){return`${e}?${Date.now()}`}function isJSON(e){try{const t=JSON.parse(e);return t||{nil:null}}catch(e){return{nil:null}}}function getLOCKS(){return isJSON(localStorage.getItem(lockStorage))}function setLOCKS(e){localStorage.setItem(lockStorage,JSON.stringify(e))}function isLOCK(e){const t=isJSON(localStorage.getItem(lockStorage));return void 0!==t[e]&&Date.now()-t[e]<=lockTimeout}function LOCK(e){let t=getLOCKS();t[e]=Date.now(),setLOCKS(t)}function unLOCK(e){let t=getLOCKS();delete t[e],setLOCKS(t)}const qFrm=body.querySelector("#qFrm"),qTxt=body.querySelector("#qTxt"),closeBtn=body.querySelector("#close"),planBtn=body.querySelector("#planBtn"),themeBtn=body.querySelector("#themeBtn");window.addEventListener("load",function(){currentLang=getLang(),currentLangCc=currentLang.cc,applyLang(currentLang),applyTheme(currentTheme=getTheme()),getUrl(versionPath,function(e){localStorage.setItem(versionStorage,e.responseText)})}),closeBtn.addEventListener("click",function(){const e=closeBtn.parentNode;e.querySelector("#res").innerHTML="",e.style.display="none"}),planBtn.addEventListener("click",plan),qFrm.addEventListener("submit",function(e){e.preventDefault(),find(qTxt.value,"#result",10)}),qTxt.addEventListener("keyup",function(){find(qTxt.value,"#result",10)}),themeBtn.addEventListener("click",function(){const e=themeBtn.innerText;"brightness_5brightness_2"==e?(currentTheme=availableThemes.dark,themeBtn.innerText=currentTheme.icon,setTheme(currentTheme.name)):"brightness_2"==e?(currentTheme=availableThemes.light,themeBtn.innerText=currentTheme.icon,setTheme(currentTheme.name)):(localStorage.removeItem(themeStorage),currentTheme=getTheme(),themeBtn.innerText=availableThemes.light.icon+availableThemes.dark.icon),applyTheme(currentTheme)});